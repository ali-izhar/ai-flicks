{% extends 'base_template.html' %}

{% block title %}
AIF - Customer Cart
{% endblock %}

{% block content %}
<div class="cart-items">
    <h2>Your Cart</h2><hr>
    {% set ns = namespace(total=0) %}
    <ul>
    {% for item in cart_items %}
        <li>{{ loop.index }}. {{ item.name }} - ${{ item.price }}</li>
        {% set ns.total = ns.total + item.price %}
    {% endfor %}
    </ul>
    <hr>
    <strong>Total: ${{ ns.total }}</strong>
</div> 

<div class="modal">
    <form id="payment-form" class="form" method="POST">
        <div class="input_container">
            <label for="card-holder-name" class="input_label">Full Name</label>
            <input id="card-holder-name" class="input_field" type="text" name="card_holder_name" title="Input title" placeholder="Enter your full name" required>
        </div>

        <div class="input_container">
            <label for="card-holder-address" class="input_label">Address</label>
            <input id="card-holder-address" class="input_field" type="text" name="card_holder_address" title="Input title" placeholder="Street address" required>
        </div>

        <div class="input_container">
            <label for="card-holder-email" class="input_label">Email</label>
            <input id="card-holder-email" class="input_field" type="text" name="card_holder_email" title="Input title" placeholder="Enter your email" required>
        </div>

        <div class="input_container">
            <label for="card-holder-phone" class="input_label">Phone</label>
            <input id="card-holder-phone" class="input_field" type="text" name="card_holder_phone" title="Input title" placeholder="Enter your phone number" required>
        </div>

        <div class="input_container">
            <label for="card-number" class="input_label" aria-required="true">Card Number</label>
            <div id="card-number" class="input_field"></div>
        </div>

        <div class="input_container">
            <input type="hidden" name="generated-image" id="generated-image" value="">
        </div>

        <div class="input_container">
            <input type="hidden" name="total" id="total" value="">
        </div>

        <button class="purchase--btn" type="submit" name="submit">Checkout</button>
    </form>
</div>

<!-- Add the Stripe.js library to your HTML file -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("pk_test_TYooMQauvdEDq54NiTphI7jx");
    const elements = stripe.elements();
    const cardElement = elements.create("card", {hidePostalCode: true});
    cardElement.mount("#card-number");

    const form = document.getElementById("payment-form");

    form.addEventListener("submit", async (event) => {
        event.preventDefault();

        // Get the cardholder's name
        const cardholderName = document.getElementById("card-holder-name").value;

        // Create a payment method
        const {paymentMethod, error} = await stripe.createPaymentMethod({
            type: "card",
            card: cardElement,
            billing_details: {
                name: cardholderName,
            },
        });

        if (error) {
            // Show an error message to the user
            console.error(error.message);
        } else {
            // Send the payment method ID to the server
            const response = await fetch("/payment", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    paymentMethodId: paymentMethod.id,
                    amount: 1000, // Replace with the actual amount
                }),
            });

            const result = await response.json();

            if (result.success) {
                // Payment succeeded, show a success message
                console.log("Payment succeeded");
                  // Payment succeeded, submit the form data to the email_user route
                const formData = new FormData(form);
                
                fetch("{{ url_for('email_user') }}", {
                    method: "POST",
                    body: formData,
                });
            } else {
                // Payment failed, show an error message
                console.error(result.message);
            }
        }
    });
</script>

  
{% endblock %}